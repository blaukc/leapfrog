services:
  backend:
    env_file:
      - .env
    build:
      context: .
      dockerfile: backend/Dockerfile
      args:
        - BACKEND_PORT=${BACKEND_PORT}
    ports:
      - "${BACKEND_PORT}:8000"
    environment:
      PYTHONUNBUFFERED: "1"
      BACKEND_PORT: ${BACKEND_PORT}
      BACKEND_HOST: ${BACKEND_HOST}
      BACKEND_DOMAIN: ${BACKEND_DOMAIN}
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS}"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${BACKEND_PORT}/" ]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    env_file:
      - .env
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL}
        VITE_WS_BASE_URL: ${VITE_WS_BASE_URL}
    # frontend will be served internally; Caddy will be the public TLS terminator
    depends_on:
      - backend

  caddy:
    image: caddy:2
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frontend
      - backend

networks:
  default:
    name: leapfrog_default

volumes:
  caddy_data:
  caddy_config:
